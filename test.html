<!DOCTYPE html>
<html>
  <head>
    <title>Chat</title>
  </head>
  <body>
    <h1>WebSocket Stream</h1>
    <script>
      // Create a new WebSocket connection
      const socket = new WebSocket(
        "ws://localhost:8000/api/stream-chunk/OTgybQWgpEAGfCnpvWe68"
      );

      const audioChunks = [];

      window.onload = function () {
        const audioContext = new AudioContext();
      };

      function processAudioChunks() {
        const concatenatedChunks = new Blob(audioChunks);
        const fileReader = new FileReader();

        fileReader.onload = function () {
          const arrayBuffer = this.result;

          audioContext.decodeAudioData(arrayBuffer, (decodedData) => {
            const audioBufferSourceNode = audioContext.createBufferSource();
            audioBufferSourceNode.buffer = decodedData;
            audioBufferSourceNode.connect(audioContext.destination);
            audioBufferSourceNode.start();
          });
        };

        fileReader.readAsArrayBuffer(concatenatedChunks);

        // Clear the audioChunks array for the next set of chunks
        audioChunks.length = 0;
      }

      socket.addEventListener("message", (event) => {
        const audioChunk = event.data;
        audioChunks.push(audioChunk);

        // Check if enough audio chunks have been accumulated to start playing
        if (audioChunks.length >= 5) {
          processAudioChunks();
        }
      });
    </script>
  </body>
</html>
